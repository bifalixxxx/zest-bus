<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Zest Bus ‚Äì horaires</title>

  <!-- Google AdSense (validation + auto-ads) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5005112174057245" crossorigin="anonymous"></script>

  <style>
    :root{--bg:#0a0a0b;--card:#131317;--text:#fafafc;--subtle:#a9abb6;--pill:#1e1e25}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0b0c12;color:var(--text)}
    header{position:sticky;top:0;display:flex;gap:12px;align-items:center;padding:14px 16px;background:rgba(10,10,11,.85);backdrop-filter:blur(8px);border-bottom:1px solid #1f2030;z-index:5}
    header img{width:40px;height:40px;border-radius:10px;object-fit:cover}
    main{padding:16px;max-width:960px;margin:0 auto}
    .search{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.row{grid-template-columns:2fr 1fr 1fr}}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #26283a;background:#0f0f15;color:var(--text);font-size:16px}
    .cards{display:grid;grid-template-columns:1fr;gap:12px;margin-top:18px}
    @media(min-width:900px){.cards{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #232437;border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px 0;font-size:16px}
    .meta{color:var(--subtle);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;margin-top:10px}
    .badge{padding:2px 6px;border-radius:8px;font-size:12px;background:#1f273a;color:#cbd5e1}
    .badge.red{background:#3b0f12;color:#fecaca;border:1px solid #7f1d1d}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px}
    .banner{background:#991b1b;color:#fff;text-align:center;padding:10px 12px;font-weight:700;display:none}
    footer{color:#7b7f8f;font-size:12px;text-align:center;padding:20px 10px}
    .disclaimer{color:#fecaca;background:#3b0f12;border:1px solid #7f1d1d;border-radius:10px;padding:10px;max-width:960px;margin:10px auto 0}
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="logo" onerror="this.style.display='none'"/>
  <div>
    <div style="font-weight:800">Zest Bus</div>
    <div style="color:#94a3b8;font-size:12px">Horaires & prochains passages</div>
  </div>
</header>

<main>
  <div id="topBanner" class="banner"></div>

  <section class="search">
    <div class="row">
      <input id="q" type="search" placeholder="Rechercher un arr√™t‚Ä¶ (ex: Pont Ste D√©vote, March√©, Les Platanes)"/>
      <select id="line"><option value="">Toutes lignes</option></select>
      <select id="dir"><option value="">Tous sens</option></select>
    </div>
    <div class="row">
      <div class="pill">‚è±Ô∏è Retards trafic (appliqu√©s)</div>
      <div class="pill">üöå Retard moyen: <span id="avgDelay">0 min</span></div>
      <div class="pill">‚ö†Ô∏è Ligne la + perturb√©e: <span id="mostPert">‚Äî</span></div>
    </div>
  </section>

  <div id="results" class="cards"></div>

  <ins class="adsbygoogle"
       style="display:block; text-align:center; margin:20px auto;"
       data-ad-client="ca-pub-5005112174057245"
       data-ad-slot="1234567890"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>try{(adsbygoogle=window.adsbygoogle||[]).push({});}catch(e){}</script>
</main>

<footer>
  <div class="disclaimer">¬© 2025 ‚Äî Ce site est un projet √©tudiant et n‚Äôa aucun lien avec la soci√©t√© Zest Bus/Keolis.</div>
  <div>JSON statique + retards appliqu√©s.</div>
</footer>

<script>
(() => {
  // APIs
  const DELAYS_API = "/api/delays";       // renvoie soit { "11":n,... } soit { delays:{...} }
  const OVERRIDES_API = "/api/overrides"; // pour r√©cup√©rer banner/mode/multiplicateur (GET public)

  const state = { DB:null, DELAYS:{}, OV:{ banner:"" } };
  const $ = s => document.querySelector(s);
  const results = $('#results'), qInput = $('#q'), lineSel = $('#line'), dirSel = $('#dir');
  const avgDelayEl = $('#avgDelay'), mostPertEl = $('#mostPert'), bannerEl = $('#topBanner');

  const KNOWN_LINES = ["11","12","13","18","24"];
  const pad = n => n<10 ? '0'+n : ''+n;

  function minsFromNow(hhmm){
    const now=new Date();
    const [h,m]=hhmm.split(':').map(Number);
    const dt=new Date(now); dt.setHours(h,m,0,0);
    let diff=Math.round((dt-now)/60000);
    if(diff<-720) diff+=1440;
    return Math.max(0, diff); // affichage jamais n√©gatif
  }
  function addMinutes(hhmm, add){
    const [h,m]=hhmm.split(':').map(Number);
    let total=h*60+m+add;
    total=(total%1440+1440)%1440;
    return pad(Math.floor(total/60))+':'+pad(total%60);
  }
  function nextTimes(times, limit=4){
    const nowMin=new Date().getHours()*60+new Date().getMinutes();
    const day=times.map(t=>{const [h,m]=t.split(':').map(Number);return h*60+m});
    const future=day.filter(tm=>tm>=nowMin);
    const pick=(future.length?future:day).slice(0,limit);
    return pick.map(tm=>pad(Math.floor(tm/60))+':'+pad(tm%60));
  }

  function badgeHTML(delay){
    const v = Number(delay)||0;
    const cls = v>0 ? 'badge red' : 'badge';
    return `<span class="${cls}">+${v}</span>`;
  }

  function getLineDelay(line){
    const base = Number(state.DELAYS[line])||0;
    const m = Number(state.OV.multiplier||1);
    if (state.OV.mode === 'manual') {
      const man = Number(state.OV.manual?.[line]);
      return Number.isFinite(man) ? man : 0;
    }
    return Math.round(base * (m||1));
  }

  function computeKPIs(){
    const entries = Object.keys(state.DELAYS).map(k=>[k, getLineDelay(k)]);
    if(!entries.length){ avgDelayEl.textContent='0 min'; mostPertEl.textContent='‚Äî'; return; }
    const avg = Math.round(entries.reduce((a,[,v])=>a+v,0)/entries.length);
    const max = entries.reduce((b,c)=> c[1]>b[1]?c:b, ["‚Äî",0]);
    avgDelayEl.textContent = `${avg} min`;
    mostPertEl.textContent = `Ligne ${max[0]} (+${max[1]} min)`;
  }

  function populateSelectors(){
    const lines = [...new Set([
      ...state.DB.lines.map(l=>String(l.line).trim()),
      ...KNOWN_LINES
    ])].sort((a,b)=>Number(a)-Number(b));
    lineSel.innerHTML = '<option value="">Toutes lignes</option>' +
      lines.map(ln=>`<option value="${ln}">Ligne ${ln}</option>`).join('');
    updateDirOptions();
  }
  function updateDirOptions(){
    const ln = lineSel.value;
    const dirs=[];
    state.DB.lines.filter(l=>!ln || String(l.line).trim()===ln)
      .forEach(l=>l.directions.forEach(d=>dirs.push(d.direction)));
    dirSel.innerHTML = '<option value="">Tous sens</option>' +
      [...new Set(dirs)].map(d=>`<option value="${d}">${d}</option>`).join('');
  }

  function filterStops(){
    const q = (qInput.value||'').toLowerCase().trim();
    const ln = lineSel.value, dir = dirSel.value;
    const out=[];
    state.DB.lines.forEach(line=>{
      const lnStr=String(line.line).trim();
      if(ln && lnStr!==ln) return;
      line.directions.forEach(d=>{
        if(dir && d.direction!==dir) return;
        d.stops.forEach(s=>{
          if(!q || s.name.toLowerCase().includes(q)){
            out.push({ line: lnStr, dir: d.direction, stop: s.name, times: s.times });
          }
        });
      });
    });
    return out;
  }

  function render(){
    const items = filterStops().slice(0,50);
    results.innerHTML='';
    if(!items.length){
      results.innerHTML='<div class="card"><div class="meta">Aucun r√©sultat ‚Äî essaye un autre arr√™t ou choisis une ligne.</div></div>';
      return;
    }
    items.forEach(it=>{
      const delay = getLineDelay(it.line);
      const nextPlan = nextTimes(it.times,4);
      const nextAdj  = nextPlan.map(t=>addMinutes(t, delay));
      const minsLeft = nextAdj.map(t=>minsFromNow(t));

      const grid = nextAdj.map((t,i)=>`
        <div>${t}</div>
        <div style="text-align:right">${minsLeft[i]} min</div>
        <div>${badgeHTML(delay)}</div>
      `).join('');

      const el=document.createElement('div'); el.className='card';
      el.innerHTML = `<h3>Ligne ${it.line} ‚Äî ${it.stop}</h3>
        <div class="meta">${it.dir}</div>
        <div class="grid">${grid}</div>`;
      results.appendChild(el);
    });
  }

  async function fetchDelays(){
    try{
      const r = await fetch(DELAYS_API, { cache:'no-store' });
      const j = r.ok ? await r.json() : {};
      // prend en charge {delays:{...}} ou simple map
      const map = (j && typeof j==='object' && j.delays) ? j.delays : j;
      const out = {};
      ["11","12","13","18","24"].forEach(k=>{
        const v = Number(map?.[k]);
        out[k] = Number.isFinite(v) ? v : 0;
      });
      state.DELAYS = out;
      computeKPIs(); render();
    }catch(e){
      state.DELAYS = {"11":0,"12":0,"13":0,"18":0,"24":0};
      computeKPIs(); render();
    }
  }

  async function fetchOverrides(){
    try{
      const r = await fetch(OVERRIDES_API, { cache:'no-store' });
      if(!r.ok) return;
      const ov = await r.json();
      state.OV = Object.assign({ mode:'auto', multiplier:1, manual:{}, banner:'' }, ov||{});
      if(state.OV.banner){ bannerEl.textContent = state.OV.banner; bannerEl.style.display='block'; }
    }catch(_){}
  }

  async function init(){
    try{
      const dbRes = await fetch('./zekst_bus.json', { cache:'no-store' });
      if(!dbRes.ok) throw new Error('Chargement zekst_bus.json: '+dbRes.status);
      state.DB = await dbRes.json();
      state.DB.lines.forEach(l=>l.line=String(l.line).trim());

      await fetchOverrides();      // bandeau + overrides (si dispo)
      populateSelectors(); render();
      await fetchDelays();         // retards initiaux
      setInterval(fetchDelays, 120000);

      qInput.addEventListener('input', render);
      lineSel.addEventListener('change', ()=>{ updateDirOptions(); render(); });
      dirSel.addEventListener('change', render);
    }catch(err){
      console.error(err);
      results.innerHTML = '<div class="card"><div class="meta">Erreur de chargement. V√©rifie que <code>zekst_bus.json</code> est √† c√¥t√© de <code>index.html</code>.</div></div>';
    }
  }
  window.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
